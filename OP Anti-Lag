-- ⚡ SMART ANTI-LAG ⚡
-- Aggressively reduces lag without hammering the CPU

local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- === CLEANUP SETTINGS ===
local destroyTypes = {
    "ParticleEmitter", "Trail", "Beam", "Fire", "Smoke", "Sparkles",
    "Explosion", "ForceField", "Highlight", "ShirtGraphic",
    "Decal", "Texture", "SurfaceAppearance", "Shirt", "Pants"
}

-- Keep track of already cleaned objects to avoid re-checking them
local cleaned = {}

local function cleanObject(obj)
    if cleaned[obj] then return end

    -- Kill unwanted classes
    for _, className in ipairs(destroyTypes) do
        if obj:IsA(className) then
            obj:Destroy()
            return -- destroyed, no need to continue
        end
    end

    -- Parts optimization
    if obj:IsA("BasePart") then
        obj.Material = Enum.Material.SmoothPlastic
        obj.Reflectance = 0
        if obj.Transparency < 0.05 then
            obj.CastShadow = false
        end
        if not obj.Anchored and not obj.CanCollide then
            obj.CanCollide = false
        end
    end

    -- Stop sounds
    if obj:IsA("Sound") then
        obj:Stop()
        obj.Volume = 0
    end

    cleaned[obj] = true
end

-- Batch-cleaning function (avoids freezing)
local function batchClean(objects)
    local batchSize = 100 -- number of objects per frame
    local index = 1
    local total = #objects

    local conn
    conn = RunService.Heartbeat:Connect(function()
        for i = 1, batchSize do
            if index > total then
                conn:Disconnect()
                return
            end
            cleanObject(objects[index])
            index += 1
        end
    end)
end

-- Collect all objects in workspace + lighting
local function collectAllObjects(root)
    local all = {}
    local function recurse(obj)
        table.insert(all, obj)
        for _, child in ipairs(obj:GetChildren()) do
            recurse(child)
        end
    end
    recurse(root)
    return all
end

-- Initial cleanup
batchClean(collectAllObjects(workspace))
batchClean(collectAllObjects(Lighting))

-- === LIGHTING OPTIMIZATION ===
Lighting.GlobalShadows = false
Lighting.FogEnd = 9e9
Lighting.Brightness = 1
pcall(function() Lighting.Technology = Enum.Technology.Compatibility end)

-- === TERRAIN OPTIMIZATION ===
pcall(function()
    workspace.Terrain.WaterReflectance = 0
    workspace.Terrain.WaterTransparency = 1
    workspace.Terrain.WaterWaveSize = 0
    workspace.Terrain.WaterWaveSpeed = 0
    workspace.Terrain.Decoration = false
end)

-- === OPTIONAL: Periodic light cleaning loop (safe, low frequency) ===
RunService.Heartbeat:Connect(function()
    for _, obj in ipairs(workspace:GetChildren()) do
        cleanObject(obj)
    end
end)

print("⚡ SMART ANTI-LAG ENABLED ⚡")
