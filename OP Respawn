-- âš¡ ULTRA-INSTANT RESPAWN

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local GuideEvent = ReplicatedStorage:FindFirstChild("Guide")

-- === SETTINGS ===
local TOGGLE_KEY = Enum.KeyCode.R -- Press this to toggle auto-respawn

-- === GLOBAL CONTROL ===
_G.UltraRespawn = _G.UltraRespawn or { Active = false, Connections = {} }

local function disconnectAll()
	for _, conn in ipairs(_G.UltraRespawn.Connections) do
		if conn and conn.Connected then
			conn:Disconnect()
		end
	end
	table.clear(_G.UltraRespawn.Connections)
end

local function fireGuideOnce()
	if GuideEvent then
		pcall(function()
			GuideEvent:FireServer()
		end)
	else
		pcall(function()
			LocalPlayer:LoadCharacter()
		end)
	end
end

-- === Hook Character ===
local function hookCharacter(char)
	local humanoid = char:WaitForChild("Humanoid", 1)
	if not humanoid then return end

	local respawned = false
	local function tryRespawn(trigger)
		if not _G.UltraRespawn.Active or respawned then return end
		respawned = true
		task.defer(fireGuideOnce)
	end

	local diedConn = humanoid.Died:Connect(function()
		tryRespawn("HumanoidDied")
	end)

	local healthConn = humanoid:GetPropertyChangedSignal("Health"):Connect(function()
		if humanoid.Health <= 0 then
			tryRespawn("HealthZero")
		end
	end)

	local ancestryConn = char.AncestryChanged:Connect(function(_, parent)
		if not parent then
			tryRespawn("ModelRemoved")
		end
	end)

	local hbConn
	hbConn = RunService.Heartbeat:Connect(function()
		if not char.Parent or humanoid.Health <= 0 then
			if hbConn then hbConn:Disconnect() end
			tryRespawn("HeartbeatFailSafe")
		end
	end)

	table.insert(_G.UltraRespawn.Connections, diedConn)
	table.insert(_G.UltraRespawn.Connections, healthConn)
	table.insert(_G.UltraRespawn.Connections, ancestryConn)
	table.insert(_G.UltraRespawn.Connections, hbConn)
end

-- === Character Added ===
local function onCharacterAdded(char)
	task.defer(function()
		hookCharacter(char)
	end)
end

-- === Enable/Disable Logic ===
local function toggleRespawn()
	_G.UltraRespawn.Active = not _G.UltraRespawn.Active
	disconnectAll()

	if _G.UltraRespawn.Active then
		print("ðŸ’  [Auto-Respawn ENABLED]")
		table.insert(_G.UltraRespawn.Connections,
			Players.LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
		)
		if LocalPlayer.Character then
			onCharacterAdded(LocalPlayer.Character)
		end
	else
		print("ðŸ’  [Auto-Respawn DISABLED]")
	end
end

-- === Keybind ===
UIS.InputBegan:Connect(function(input, gameProcessed)
	if not gameProcessed and input.KeyCode == TOGGLE_KEY then
		toggleRespawn()
	end
end)

print("ðŸ’  ULTRA-INSTANT GUIDE RESPAWN â€” Keybind Edition Initialized. "Press [" .. TOGGLE_KEY.Name .. "] to toggle Auto-Respawn")
