-- CONFIG
local auraRange = 20
local auraSize = Vector3.new(30, 30, 30)
local attackRate = 0.1

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- STATE
local running = true
local auraParams = OverlapParams.new()
auraParams.FilterType = Enum.RaycastFilterType.Include

local mouseDown = false

UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        mouseDown = true
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        mouseDown = false
    end
end)

local function getChar(plr)
    return plr.Character
end

local function getHRP(plr)
    local c = getChar(plr)
    return c and c:FindFirstChild("HumanoidRootPart")
end

local function getTargets()
    local myHRP = getHRP(LocalPlayer)
    if not myHRP then return {}, {} end

    local plrs, chars = {}, {}

    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            local hrp = getHRP(p)
            if hrp and (hrp.Position - myHRP.Position).Magnitude <= auraRange then
                table.insert(plrs, p)
                table.insert(chars, getChar(p))
            end
        end
    end

    return plrs, chars
end

local function getTouchPart(tool)
    local tx = tool:FindFirstChildWhichIsA("TouchTransmitter", true)
    return tx and tx.Parent
end

-- MAIN LOOP
task.spawn(function()
    while running do
        local char = getChar(LocalPlayer)
        if not char then task.wait(1) continue end

        local targets, enemyChars = getTargets()
        auraParams.FilterDescendantsInstances = enemyChars

        for _, tool in ipairs(char:GetChildren()) do
            if tool:IsA("Tool") then
                local fightEvent = tool:FindFirstChild("FightEvent")
                local touchPart = getTouchPart(tool)

                -- ONLY ATTACK WHEN YOU HOLD MOUSE BUTTON
                if mouseDown and fightEvent then
                    fightEvent:FireServer()
                    tool:Activate()
                end

                -- ALWAYS DO AURA HITBOX (but not forced attack)
                if touchPart then
                    local parts = workspace:GetPartBoundsInBox(
                        touchPart.CFrame,
                        touchPart.Size + auraSize,
                        auraParams
                    )
                    for _, part in ipairs(parts) do
                        local mdl = part:FindFirstAncestorWhichIsA("Model")
                        if mdl and table.find(enemyChars, mdl) then
                            firetouchinterest(touchPart, part, 1)
                            firetouchinterest(touchPart, part, 0)
                        end
                    end
                end
            end
        end

        task.wait(attackRate)
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    running = true
end)

print("Aura Active - Manual Attack Control Enabled")
