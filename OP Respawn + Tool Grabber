-- ⚡ ULTRA-INSTANT RESPAWN + TOOL GRABBER FINAL FORM ⚡
-- Instant respawn on death + grabs every allowed tool the same frame you spawn

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Tycoons = workspace:WaitForChild("Tycoons")

-- Remote for respawning
local Guide = ReplicatedStorage:WaitForChild("Guide")

-- === CONFIG ===
local hitPerFrame = 3 -- how many touches per frame per pad (higher = more reliable, but noisier)
local allowedBases  = { "Stone", "Magic", "Storm" }
local excludedBases = { "Insanity", "Giant", "Dark", "Spike", "Web", "Strong" }

-- Convert to lookup sets
local allowedSet, excludedSet = {}, {}
for _, b in ipairs(allowedBases) do allowedSet[b] = true end
for _, b in ipairs(excludedBases) do excludedSet[b] = true end

-- Cache of pads
local pads = {}

-- === Pad Registering ===
local function registerPad(pad)
    local baseModel = pad.Parent and pad.Parent.Parent
    if not baseModel then return end
    local baseName = baseModel.Name
    if baseName and (allowedSet[baseName] or not excludedSet[baseName]) then
        pads[pad] = true
    end
end

local function unregisterPad(pad)
    pads[pad] = nil
end

-- Initialize existing pads
for _, v in ipairs(Tycoons:GetDescendants()) do
    if v:IsA("TouchTransmitter") and v.Parent and v.Parent.Parent and v.Parent.Parent.Name:find("GearGiver1") then
        registerPad(v.Parent)
    end
end

-- Watch for new/removed pads
Tycoons.DescendantAdded:Connect(function(desc)
    if desc:IsA("TouchTransmitter") and desc.Parent and desc.Parent.Parent and desc.Parent.Parent.Name:find("GearGiver1") then
        registerPad(desc.Parent)
    end
end)

Tycoons.DescendantRemoving:Connect(function(desc)
    if desc:IsA("TouchTransmitter") then
        unregisterPad(desc.Parent)
    end
end)

-- === Tool Grabber ===
local function fireTouch(root, pad)
    pcall(function()
        firetouchinterest(root, pad, 0)
        firetouchinterest(root, pad, 1)
    end)
end

local function grabAllTools()
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    for pad in pairs(pads) do
        for i = 1, hitPerFrame do
            fireTouch(root, pad)
        end
    end
end

-- === Respawn System ===
local function forceRespawn()
    pcall(function()
        Guide:FireServer()
    end)
end

local function hookCharacter(char)
    local humanoid = char:WaitForChild("Humanoid", 2)
    if not humanoid then return end

    -- Grab tools instantly on spawn
    task.defer(grabAllTools)

    humanoid.Died:Connect(function()
        forceRespawn()
    end)

    -- Safety net: if Humanoid is removed (rare edge case)
    char.ChildRemoved:Connect(function(child)
        if child == humanoid then
            forceRespawn()
        end
    end)

    -- Frame-perfect health check
    RunService.Stepped:Connect(function()
        if humanoid and humanoid.Health <= 0 then
            forceRespawn()
        end
    end)
end

-- Hook lifecycle
LocalPlayer.CharacterAdded:Connect(hookCharacter)
if LocalPlayer.Character then
    hookCharacter(LocalPlayer.Character)
end

-- Keep grabbing tools every frame (just in case new pads spawn mid-game)
RunService.Heartbeat:Connect(grabAllTools)

print("⚡ ULTRA-INSTANT RESPAWN + TOOL GRABBER Final Form Loaded ⚡")
